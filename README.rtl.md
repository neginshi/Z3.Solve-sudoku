## Satisfiability Modulo theory
مشکل تیوری های Satisfiability Modulo (SMT) یک مشکل تصمیم گیری برای فرمول های منطقی با توجه به ترکیبات تیوری های زمینه (background) مانند حساب ، دنباله های بیتی ، آرایه ها و توابع بدون تفسیر ، است.
## Z3 
 یک حل‌کننده SMT کارآمد با الگوریتم‌های تخصصی برای حل تئوری‌های زمینه است. حل مسائل SMT از رابطه همزیستی با ابزارهای تحلیل نرم‌افزار، اعتبارسنجی، و اجرای نمادین بهره می‌برد.
از Z3 می‌توان برای بررسی رضایت‌پذیری فرمول‌های منطقی در یک یا چند تئوری استفاده کرد. Z3 تطابق قابل‌توجهی برای ابزارهای تحلیل و اعتبارسنجی نرم‌افزار ارائه می‌دهد، زیرا چندین ساختار متداول نرم‌افزار به طور مستقیم به تئوری‌های پشتیبانی‌شده نگاشت می‌شوند. Z3 یک دنباله از دستورات است.

## solve sudoku
 جدول سودوکو حاوی 81 خانه است که به شکل 9x9 در یک مربع موجود هستند.
 <br>
 این کد JavaScript یک تابع به نام toSudoku را تعریف می‌کند که یک رشته را به عنوان ورودی می‌گیرد و ماتریسی 9x9 از اعداد صحیح یا null را برمی‌گرداند که هر خانه‌ی آن می‌تواند یک عدد صحیح بین 1 تا 9 یا null باشد.<br>
 سپس ورودی را به خطوط تقسیم می‌کند و برای هر خانه از جدول سودوکو، مقدار آن را در ماتریس ایجاد شده قرار می‌دهد.
در نهایت، ماتریس سودوکو را برمی‌گرداند.
- هر خانه را یک cell در نظر می گیریم.
- هر رشته ورودی را یک data در نظر می گیریم.
<br>

توضیحات هر بخش کد در پایین آن نوشته شده.

<br>

 ```
 function toSudoku(data: string): (number | null)[][] {
    const cells: (number | null)[][] = Array.from({ length: 9 }, () => Array.from({ length: 9 }, () => null));

    const lines = data.trim().split('\n');
    for (let row = 0; row < 9; row++) {
        const line = lines[row].trim();
        for (let col = 0; col < 9; col++) {
            const char = line[col];
            if (char !== '.') {
                cells[row][col] = Number.parseInt(char);
            }
        }
    }
    return cells;
}
```

تابع `toSudoku` یک رشته ورودی به نام `data` را می‌گیرد که مشخصات یک جدول سودوکو را نشان می‌دهد. این رشته را بر حسب خطوط جدا کرده و هر خانه‌ی جدول سودوکو را بازرسی می‌کند. اگر خانه‌ای خالی نباشد (نماد آن با نقطه (`.`) نباشد)، عدد موجود در آن خانه را به عنوان یک عدد صحیح در ماتریس خروجی قرار می‌دهد. اگر خانه‌ای خالی باشد، مقدار `null` را به عنوان مقدار آن خانه در نظر می‌گیرد. سپس ماتریس حاصل را به عنوان خروجی تابع برمی‌گرداند. به این ترتیب، تابع `toSudoku` مسئول تبدیل رشته ورودی به یک جدول سودوکو است.

<br>

```
const INSTANCE = toSudoku(`
....94.3.
...51...7
.89....4.
......2.8
.6.2.1.5.
1.2......
.7....52.
9...65...
.4.97....
`);
```
<br>

این قسمت ورودی جدول سودوکو را به تابع toSudoku می‌دهد و نتیجه را در متغیر INSTANCE ذخیره می‌کند.
<br>

```
const cells = [];

for (let i = 0; i < 9; i++) {
    const row = [];
    for (let j = 0; j < 9; j++) {
        row.push(Z3.Int.const(`x_${i}_${j}`));
    }
    cells.push(row);
}

const solver = new Z3.Solver();

```
این بخش از کد، یک ماتریس 9x9 از متغیرهای عدد صحیح به نام `cells` ایجاد می‌کند. 
<br>
هر متغیر این ماتریس نمایانگر یک خانه از جدول سودوکو است. این متغیرها با استفاده از کتابخانه‌ی Z3 ایجاد می‌شوند. این متغیرها در فرآیند حل مسئله برای پیدا کردن جواب سودوکو مورد استفاده قرار می‌گیرند.

<br>

## قید های Z3
با استفاده از کتابخانه‌ی Z3، چندین قید بر روی این متغیرها اضافه می‌شود:

- هر سلول باید عددی بین 1 تا 9 داشته باشد.
- هر ردیف باید شامل اعداد مختلفی باشد.
- هر ستون باید شامل اعداد مختلفی باشد.
- هر بلوک 3x3 باید شامل اعداد مختلفی باشد.

در ادامه این چهار شرط اعمال شده :

<br>

```
// each cell contains a value 1<=x<=9
for (let i = 0; i < 9; i++) {
    for (let j = 0; j < 9; j++) {
        solver.add(cells[i][j].ge(1), cells[i][j].le(9));
    }
}

```
<br>

### هر cell باید یک عدد بین 1 تا 9 داشته باشد
این بخش از کد، یک قید را به مدل اضافه می‌کند که می‌گوید هر خانه از جدول سودوکو باید شامل یک عدد صحیح بین 1 تا 9 باشد. این قید با استفاده از متغیرهای `cells[i][j]` که نمایانگر هر خانه از جدول سودوکو است، ساخته شده و به مدل اضافه می‌شود.
<br>

### در هر ردیف هر عدد فقط یک بار آمده باشد

```
// each row contains a digit only once
for (let i = 0; i < 9; i++) {
    solver.add(Z3.Distinct(...cells[i]));
}
```
<br>

در این بخش از کد، یک قید اضافه می‌شود که بیان می‌کند هر ردیف از جدول سودوکو باید شامل اعداد مختلفی باشد. این قید با استفاده از تابع `Z3.Distinct` ساخته می‌شود که متغیرهای موجود در هر ردیف را به عنوان ورودی می‌گیرد و مطمئن می‌شود که این مقادیر همگی متمایز از هم باشند. این عملیات برای تمام ردیف‌های جدول سودوکو انجام می‌شود.
<br>

### در هر ستون هر عدد فقط یک بار آمده باشد


```
for (let j = 0; j < 9; j++) {
    const column = [];
    for (let i = 0; i < 9; i++) {
        column.push(cells[i][j]);
    }
    solver.add(Z3.Distinct(...column));
}

```

در این بخش، یک حلقه برای پیمایش هر ستون ایجاد می‌شود (j از 0 تا 8). سپس برای هر ستون، مقادیر هر خانه از آن ستون در یک آرایه به نام column جمع‌آوری می‌شود. سپس با استفاده از تابع Z3.Distinct اطمینان حاصل می‌شود که هر مقدار در این آرایه متمایز باشد.
<br>

### هر بلوک 3x3 باید شامل اعداد متمایز باشد


```
for (let iSquare = 0; iSquare < 3; iSquare++) {
    for (let jSquare = 0; jSquare < 3; jSquare++) {
        const square = [];

        for (let i = iSquare * 3; i < iSquare * 3 + 3; i++) {
            for (let j = jSquare * 3; j < jSquare * 3 + 3; j++) {
                square.push(cells[i][j]);
            }
        }

        solver.add(Z3.Distinct(...square));
    }
}

```

در این قسمت، دو حلقه تودرتو برای پیمایش بلوک‌های 3x3 ایجاد می‌شود. سپس برای هر بلوک، مقادیر هر خانه از آن بلوک در یک آرایه به نام square جمع‌آوری می‌شود. سپس با استفاده از تابع Z3.Distinct اطمینان حاصل می‌شود که هر مقدار در این آرایه متمایز باشد.

<br>

### اعمال مقادیر اولیه


```
for (let i = 0; i < 9; i++) {
    for (let j = 0; j < 9; j++) {
        const digit = INSTANCE[i][j];
        if (digit !== null) {
            solver.add(cells[i][j].eq(digit));
        }
    }
}

```


در این بخش، مقادیر اولیه موجود در جدول سودوکو اعمال می‌شوند. برای هر خانه از جدول سودوکو که مقدارش مشخص است، یک قید اضافه می‌شود که مقدار متغیر متناظر با آن خانه برابر با مقدار اولیه آن خانه باشد.

```
const is_sat = await solver.check(); // sat
const model = solver.model() as Model;
var buffer = "";

for (let i = 0; i < 9; i++) {
    for (let j = 0; j < 9; j++) {
        const v = model.eval(cells[i][j]);
        buffer += `${v}`;
    }
    buffer += "\n";
}
buffer

```
در این قسمت، مدل حل می‌شود و مقادیر متغیرها به عنوان جواب سودوکو دریافت می‌شوند. سپس مقادیر متغیرها به صورت یک جدول سودوکو در یک رشته خروجی (buffer) ذخیره می‌شوند. در نهایت، رشته buffer که حاوی جواب سودوکو است، برگشت داده می‌شود.